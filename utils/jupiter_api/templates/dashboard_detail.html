<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä Token Detail Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #00d4ff;
      --primary-dark: #00aaff;
      --secondary: #2a2a4a;
      --background: #0f0f23;
      --text: #ffffff;
      --text-muted: #aaaaaa;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--background);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.light-theme {
      --background: #f5f5f5;
      --secondary: #e0e0e0;
      --text: #333333;
      --text-muted: #666666;
    }

    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: var(--secondary);
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }

    .nav h1 {
      letter-spacing: 0.02em;
      font-weight: 600;
      margin: 0;
    }

    .nav a, .nav button {
      color: var(--primary);
      text-decoration: none;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      padding: 1rem 2rem;
      background: var(--secondary);
      flex-wrap: wrap;
    }

    .controls button {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: none;
      background: var(--primary);
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .controls button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .controls button:active {
      transform: translateY(0);
    }

    .tabs-container {
      background: var(--secondary);
      border-bottom: 1px solid var(--primary-dark);
    }

    .tabs {
      display: flex;
      padding: 0 2rem;
      gap: 0.5rem;
    }

    .tab {
      padding: 1rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .tab:hover {
      color: var(--primary);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: rgba(0, 212, 255, 0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .filter-panel {
      padding: 1rem 2rem;
      background: var(--secondary);
      border-bottom: 1px solid var(--primary-dark);
    }

    .filter-panel .filter-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .filter-panel .filter-group label {
      margin-right: 0.5rem;
      color: var(--primary);
      font-size: 0.9rem;
      align-self: center;
    }

    .filter-panel .filter-group input,
    .filter-panel .filter-group select {
      padding: 0.4rem;
      border: none;
      border-radius: 4px;
      background: var(--background);
      color: var(--text);
      width: 100px;
      font-size: 0.9rem;
    }

    .filter-panel .filter-group input:focus,
    .filter-panel .filter-group select:focus {
      outline: none;
      border: 1px solid var(--primary);
      box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
    }

    .filter-panel .filter-group .time-filter {
      width: 120px;
    }

    .filter-panel .filter-group .time-unit {
      width: 80px;
    }

    .filter-panel .filter-group .bonding-filter,
    .filter-panel .filter-group .status-filter {
      width: 140px;
    }

    .filter-active {
      border: 2px solid var(--primary) !important;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
      background: rgba(0, 212, 255, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.8rem;
    }

    th, td {
      padding: 0.6rem 0.8rem;
      border-bottom: 1px solid var(--primary-dark);
      text-align: left;
    }

    th {
      background: #0f3460;
      position: sticky;
      top: 0;
      font-size: 0.75rem;
    }

    table tr:hover {
      background: rgba(0, 212, 255, 0.1);
      transition: background 0.2s ease;
    }

    .price {
      color: #00ff88;
      font-weight: bold;
    }

    .score {
      color: #ffaa00;
      font-weight: bold;
    }

    .updated-recent {
      color: #00ff88;
      font-weight: bold;
    }

    .updated-old {
      color: #ff6b6b;
    }

    .updated-medium {
      color: #ffaa00;
    }

    .pagination {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 2rem;
      justify-content: space-between;
    }

    .pagination button {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      background: var(--primary);
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .pagination button:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    .fav {
      color: gold;
      cursor: pointer;
    }

    .no-data {
      text-align: center;
      padding: 1rem;
      color: var(--text-muted);
    }

    .preset-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .preset-btn {
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      background: var(--background);
      color: var(--primary);
      cursor: pointer;
      font-size: 0.8rem;
      border: 1px solid var(--primary-dark);
      transition: all 0.2s ease;
    }

    .preset-btn:hover {
      background: var(--primary);
      color: var(--text);
    }

    .preset-btn.active {
      background: var(--primary);
      color: var(--text);
      border: 1px solid var(--primary-dark);
      box-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
      transform: scale(1.05);
    }

    .auto-refresh-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.5rem 1rem;
      background: var(--secondary);
      border: 1px solid var(--primary-dark);
      border-radius: 6px;
      font-size: 0.9rem;
      margin-left: auto;
    }

    .toggle-switch {
      position: relative;
      width: 40px;
      height: 20px;
      background: var(--text-muted);
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: var(--primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--text);
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    .bonding-status {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
      text-transform: uppercase;
      display: inline-block;
      min-width: 60px;
      text-align: center;
    }

    .bonding-created {
      background: linear-gradient(45deg, #4CAF50, #8BC34A);
      color: #fff;
    }

    .bonding-active {
      background: linear-gradient(45deg, #FF9800, #FFC107);
      color: #000;
    }

    .bonding-completed {
      background: linear-gradient(45deg, #2196F3, #03A9F4);
      color: #fff;
    }

    .bonding-migrated {
      background: linear-gradient(45deg, #9C27B0, #E91E63);
      color: #fff;
    }

    .bonding-terminated {
      background: linear-gradient(45deg, #F44336, #FF5722);
      color: #fff;
    }

    .progress-container {
      width: 80px;
      height: 16px;
      background: var(--secondary);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      border: 1px solid var(--primary-dark);
    }

    .progress-bar {
      height: 100%;
      border-radius: 8px;
      background: linear-gradient(90deg, #ff6b35, #00ff9d);
      transition: width 0.3s ease;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.65rem;
      font-weight: bold;
      color: var(--text);
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
      z-index: 2;
    }

    .no-progress {
      color: var(--text-muted);
      font-size: 0.7rem;
      text-align: center;
    }

    .price-positive {
      color: #00ff88;
    }

    .price-negative {
      color: #ff6b6b;
    }

    .price-neutral {
      color: var(--text-muted);
    }

    .status-legend {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.5rem;
      padding: 1rem;
      background: var(--secondary);
      border-radius: 8px;
      margin: 1rem 2rem;
      font-size: 0.85rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--secondary);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .analysis-container {
      padding: 2rem;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .metric-card {
      background: var(--secondary);
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid var(--primary-dark);
    }

    .metric-title {
      color: var(--primary);
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .metric-subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .token-status {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
      text-transform: uppercase;
      display: inline-block;
      min-width: 60px;
      text-align: center;
    }

    .status-active {
      background: linear-gradient(45deg, #4CAF50, #8BC34A);
      color: #fff;
    }

    .status-inactive {
      background: linear-gradient(45deg, #FF9800, #FFC107);
      color: #000;
    }

    .status-no_dex_data {
      background: linear-gradient(45deg, #607D8B, #90A4AE);
      color: #fff;
    }

    .status-archived {
      background: linear-gradient(45deg, #9E9E9E, #BDBDBD);
      color: #000;
    }

    .status-blacklisted {
      background: linear-gradient(45deg, #F44336, #FF5722);
      color: #fff;
    }

    .status-unknown {
      background: linear-gradient(45deg, #424242, #616161);
      color: #fff;
    }

    @media (max-width: 768px) {
      .nav {
        flex-direction: column;
        gap: 0.5rem;
      }

      .controls {
        flex-direction: column;
        align-items: flex-start;
      }

      .filter-group {
        flex-direction: column;
      }

      .filter-panel input,
      .filter-panel select {
        width: 100%;
      }

      .tabs {
        flex-wrap: wrap;
        padding: 0 1rem;
      }

      .filter-panel {
        padding: 1rem;
      }

      th, td {
        padding: 0.3rem 0.2rem;
        font-size: 0.75rem;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div class="nav">
    <h1>üìä Token Detail Report</h1>
    <div>
      <a href="/dashboard">‚Üê Retour au Dashboard</a>
      <button onclick="toggleTheme()" aria-label="Basculer entre mode sombre et clair">üåô</button>
    </div>
  </div>

  <!-- Contr√¥les -->
  <div class="controls">
    <button onclick="reloadData()" aria-label="Actualiser les donn√©es">üîÑ Actualiser</button>
    <button onclick="resetFilters()" aria-label="R√©initialiser les filtres">üßπ R√©initialiser Filtres</button>
    <button onclick="exportToCSV()" aria-label="Exporter les donn√©es en CSV">üì• Exporter en CSV</button>
    <label>Afficher
      <select id="perPage" onchange="changePerPage()" aria-label="Nombre de tokens par page">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select> tokens
    </label>
    <div class="auto-refresh-section">
      <div class="auto-refresh-toggle">
        <label for="autoRefreshEnabled">Auto-refresh:</label>
        <div class="toggle-switch active" id="autoRefreshToggle" onclick="toggleAutoRefresh()"></div>
      </div>
      <select id="refreshInterval" onchange="updateRefreshInterval()" aria-label="Intervalle de rafra√Æchissement automatique">
        <option value="5000">5s</option>
        <option value="10000">10s</option>
        <option value="30000" selected>30s</option>
        <option value="60000">1min</option>
        <option value="300000">5min</option>
      </select>
      <div class="refresh-indicator active" id="refreshIndicator">
        <span>üîÑ</span>
        <span id="refreshStatus">Auto-refresh: 30s</span>
      </div>
    </div>
  </div>

  <!-- Onglets -->
  <div class="tabs-container">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('base', this)" aria-label="Afficher les donn√©es de base">üìä Donn√©es de Base</button>
      <button class="tab" onclick="switchTab('dexscreener', this)" aria-label="Afficher les donn√©es DexScreener">üìà DexScreener</button>
      <button class="tab" onclick="switchTab('analysis', this)" aria-label="Afficher l'analyse des donn√©es">üî¨ Analyse</button>
    </div>
  </div>

  <!-- Contenu Onglet Donn√©es de Base -->
  <div id="base-content" class="tab-content active">
    <div class="status-legend">
      <div class="legend-item">
        <span class="bonding-status bonding-created">Created</span>
        <span>Nouveau token d√©tect√©</span>
      </div>
      <div class="legend-item">
        <span class="bonding-status bonding-active">Active</span>
        <span>Bonding curve en cours</span>
      </div>
      <div class="legend-item">
        <span class="bonding-status bonding-completed">Completed</span>
        <span>Bonding curve termin√©e</span>
      </div>
      <div class="legend-item">
        <span class="bonding-status bonding-migrated">Migrated</span>
        <span>Migr√© vers Raydium</span>
      </div>
      <div class="legend-item">
        <span class="bonding-status bonding-terminated">Terminated</span>
        <span>Bonding curve arr√™t√©e</span>
      </div>
    </div>

    <div class="filter-panel">
      <div class="filter-group">
        <label>üïí Mis √† jour depuis:</label>
        <div class="preset-buttons">
          <button class="preset-btn" onclick="setTimeFilter(15, 'minutes', this)" aria-label="Filtrer les mises √† jour des derni√®res 15 minutes">15min</button>
          <button class="preset-btn" onclick="setTimeFilter(30, 'minutes', this)" aria-label="Filtrer les mises √† jour des derni√®res 30 minutes">30min</button>
          <button class="preset-btn" onclick="setTimeFilter(1, 'hours', this)" aria-label="Filtrer les mises √† jour des derni√®res 1 heure">1h</button>
          <button class="preset-btn" onclick="setTimeFilter(6, 'hours', this)" aria-label="Filtrer les mises √† jour des derni√®res 6 heures">6h</button>
          <button class="preset-btn" onclick="setTimeFilter(24, 'hours', this)" aria-label="Filtrer les mises √† jour des derni√®res 24 heures">24h</button>
          <button class="preset-btn" onclick="clearTimeFilter(this)" aria-label="Supprimer le filtre de temps">Tout</button>
        </div>
        <input type="number" id="filterTimeValue" class="time-filter" placeholder="Valeur" min="1" aria-label="Valeur du filtre de temps">
        <select id="filterTimeUnit" class="time-unit" aria-label="Unit√© de temps pour le filtre">
          <option value="">-</option>
          <option value="minutes">Minutes</option>
          <option value="hours">Heures</option>
          <option value="days">Jours</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Symbol:</label>
        <input type="text" id="filterSymbol" placeholder="Symbol (e.g., DNT)" aria-label="Filtrer par symbole">
        <label>üîó Bonding Curve:</label>
        <select id="filterBondingStatus" class="bonding-filter" aria-label="Filtrer par statut de bonding curve">
          <option value="">Tous les statuts</option>
          <option value="created">Created (Nouveau)</option>
          <option value="active">Active (En cours)</option>
          <option value="completed">Completed (Termin√©e)</option>
          <option value="migrated">Migrated (Migr√©e)</option>
          <option value="terminated">Terminated (Arr√™t√©e)</option>
          <option value="unknown">Unknown (Inconnu)</option>
        </select>
        <label>Progress Min (%):</label>
        <input type="number" id="filterProgressMin" placeholder="Min %" min="0" max="100" step="1" style="width: 80px;" aria-label="Progression minimale de bonding curve">
        <label>Progress Max (%):</label>
        <input type="number" id="filterProgressMax" placeholder="Max %" min="0" max="100" step="1" style="width: 80px;" aria-label="Progression maximale de bonding curve">
        <label>Price Min ($):</label>
        <input type="number" id="filterPriceMin" placeholder="Min" step="0.000001" aria-label="Prix minimum">
        <label>Price Max ($):</label>
        <input type="number" id="filterPriceMax" placeholder="Max" step="0.000001" aria-label="Prix maximum">
      </div>
      <div class="filter-group">
        <label>Score Min:</label>
        <input type="number" id="filterScoreMin" placeholder="Min" step="0.1" aria-label="Score minimum">
        <label>Score Max:</label>
        <input type="number" id="filterScoreMax" placeholder="Max" step="0.1" aria-label="Score maximum">
        <label>Liquidity Min ($):</label>
        <input type="number" id="filterLiquidityMin" placeholder="Min 5000" title="Recommand√©: ‚â• 5,000 $" aria-label="Liquidit√© minimale">
        <label>Liquidity Max ($):</label>
        <input type="number" id="filterLiquidityMax" placeholder="Max" aria-label="Liquidit√© maximale">
        <label>Volume Min ($):</label>
        <input type="number" id="filterVolumeMin" placeholder="Min 100000" title="Recommand√©: ‚â• 100,000 $" aria-label="Volume minimum">
        <label>Volume Max ($):</label>
        <input type="number" id="filterVolumeMax" placeholder="Max" aria-label="Volume maximum">
      </div>
      <div class="filter-group">
        <label>Holders Min:</label>
        <input type="number" id="filterHoldersMin" placeholder="Min 500" title="Recommand√©: ‚â• 500" aria-label="Nombre minimum de holders">
        <label>Holders Max:</label>
        <input type="number" id="filterHoldersMax" placeholder="Max" aria-label="Nombre maximum de holders">
        <label>Age Min (h):</label>
        <input type="number" id="filterAgeMin" placeholder="Min 6" step="0.1" title="Recommand√©: ‚â• 6 heures" aria-label="√Çge minimum en heures">
        <label>Age Max (h):</label>
        <input type="number" id="filterAgeMax" placeholder="Max" step="0.1" aria-label="√Çge maximum en heures">
        <label>Risk Min:</label>
        <input type="number" id="filterRiskMin" placeholder="Min" aria-label="Risque minimum">
        <label>Risk Max:</label>
        <input type="number" id="filterRiskMax" placeholder="Max 50" title="Recommand√©: ‚â§ 50" aria-label="Risque maximum">
        <label>Date D√©couverte:</label>
        <input type="date" id="filterDiscoveredAt" placeholder="Discovered At" aria-label="Date de d√©couverte">
      </div>
    </div>

    <table id="baseTable" aria-label="Tableau des donn√©es de base des tokens">
      <thead>
        <tr>
          <th>‚≠ê</th>
          <th>Symbol</th>
          <th title="Prix en USD">Price ($)</th>
          <th title="Score d'investissement bas√© sur l'analyse algorithmique">Score</th>
          <th title="Liquidit√© en USD">Liquidity ($)</th>
          <th title="Volume des derni√®res 24 heures">Volume 24h ($)</th>
          <th>Holders</th>
          <th title="√Çge du token en heures">Age (h)</th>
          <th title="Niveau de risque (100 - rug_score)">Risk</th>
          <th title="Statut de la bonding curve">Bonding Curve</th>
          <th title="Progression de la bonding curve">Progress</th>
          <th title="Derni√®re mise √† jour">Derni√®re MAJ</th>
          <th title="Date de d√©couverte">D√©couvert</th>
        </tr>
      </thead>
      <tbody id="baseTbody"></tbody>
    </table>
  </div>

  <!-- Contenu Onglet DexScreener -->
  <div id="dexscreener-content" class="tab-content">
    <div class="filter-panel">
      <div class="filter-group">
        <label>Symbol:</label>
        <input type="text" id="dexFilterSymbol" placeholder="Symbol" aria-label="Filtrer par symbole">
        <label>üìä Status:</label>
        <select id="dexFilterStatus" class="status-filter" aria-label="Filtrer par statut">
          <option value="">Tous les status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="no_dex_data">No Dex Data</option>
          <option value="archived">Archived</option>
          <option value="blacklisted">Blacklisted</option>
        </select>
        <label>Prix DexScreener Min ($):</label>
        <input type="number" id="dexFilterPriceMin" placeholder="Min" step="0.000001" aria-label="Prix minimum DexScreener">
        <label>Prix DexScreener Max ($):</label>
        <input type="number" id="dexFilterPriceMax" placeholder="Max" step="0.000001" aria-label="Prix maximum DexScreener">
        <label>Market Cap Min ($):</label>
        <input type="number" id="dexFilterMarketCapMin" placeholder="Min" aria-label="Market cap minimum">
        <label>Market Cap Max ($):</label>
        <input type="number" id="dexFilterMarketCapMax" placeholder="Max" aria-label="Market cap maximum">
      </div>
      <div class="filter-group">
        <label>Volume 1h Min:</label>
        <input type="number" id="dexFilterVolume1hMin" placeholder="Min" aria-label="Volume minimum 1h">
        <label>Volume 6h Min:</label>
        <input type="number" id="dexFilterVolume6hMin" placeholder="Min" aria-label="Volume minimum 6h">
        <label>Volume 24h Min:</label>
        <input type="number" id="dexFilterVolume24hMin" placeholder="Min" aria-label="Volume minimum 24h">
        <label>Transactions 24h Min:</label>
        <input type="number" id="dexFilterTxns24hMin" placeholder="Min" aria-label="Transactions minimum 24h">
      </div>
      <div class="filter-group">
        <label>Buys 24h Min:</label>
        <input type="number" id="dexFilterBuys24hMin" placeholder="Min" aria-label="Achats minimum 24h">
        <label>Sells 24h Max:</label>
        <input type="number" id="dexFilterSells24hMax" placeholder="Max" aria-label="Ventes maximum 24h">
        <label>Liquidity Quote Min:</label>
        <input type="number" id="dexFilterLiquidityQuoteMin" placeholder="Min" aria-label="Liquidit√© quote minimum">
        <label>Avec donn√©es DexScreener:</label>
        <select id="dexFilterHasData" aria-label="Filtrer par disponibilit√© des donn√©es DexScreener">
          <option value="">Tous</option>
          <option value="true">Oui</option>
          <option value="false">Non</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Derni√®re MAJ DexScreener:</label>
        <div class="preset-buttons">
          <button class="preset-btn" onclick="setDexTimeFilter(5, 'minutes', this)" aria-label="Filtrer les mises √† jour DexScreener des derni√®res 5 minutes">5m</button>
          <button class="preset-btn" onclick="setDexTimeFilter(30, 'minutes', this)" aria-label="Filtrer les mises √† jour DexScreener des derni√®res 30 minutes">30m</button>
          <button class="preset-btn" onclick="setDexTimeFilter(1, 'hours', this)" aria-label="Filtrer les mises √† jour DexScreener des derni√®res 1 heure">1h</button>
          <button class="preset-btn" onclick="setDexTimeFilter(6, 'hours', this)" aria-label="Filtrer les mises √† jour DexScreener des derni√®res 6 heures">6h</button>
          <button class="preset-btn" onclick="setDexTimeFilter(24, 'hours', this)" aria-label="Filtrer les mises √† jour DexScreener des derni√®res 24 heures">24h</button>
          <button class="preset-btn" onclick="clearDexTimeFilter(this)" aria-label="Supprimer le filtre de temps DexScreener">Tout</button>
        </div>
      </div>
    </div>

    <table id="dexscreenerTable" aria-label="Tableau des donn√©es DexScreener">
      <thead>
        <tr>
          <th>‚≠ê</th>
          <th>Symbol</th>
          <th title="Statut du token">Status</th>
          <th title="Prix DexScreener en USD">Prix DS ($)</th>
          <th title="Capitalisation boursi√®re">Market Cap ($)</th>
          <th title="Liquidit√© de la devise de base">Liq. Base</th>
          <th title="Liquidit√© de la devise de cotation">Liq. Quote ($)</th>
          <th title="Volume des derni√®res 1 heure">Vol 1h ($)</th>
          <th title="Volume des derni√®res 6 heures">Vol 6h ($)</th>
          <th title="Volume des derni√®res 24 heures">Vol 24h ($)</th>
          <th title="Changement de prix sur 1 heure">Œî Prix 1h (%)</th>
          <th title="Changement de prix sur 6 heures">Œî Prix 6h (%)</th>
          <th title="Changement de prix sur 24 heures">Œî Prix 24h (%)</th>
          <th title="Transactions sur 1 heure">Txns 1h</th>
          <th title="Transactions sur 6 heures">Txns 6h</th>
          <th title="Transactions sur 24 heures">Txns 24h</th>
          <th title="Achats sur 1 heure">Buys 1h</th>
          <th title="Ventes sur 1 heure">Sells 1h</th>
          <th title="Achats sur 24 heures">Buys 24h</th>
          <th title="Ventes sur 24 heures">Sells 24h</th>
          <th title="Lien vers DexScreener">URL DexScreener</th>
          <th title="Date de cr√©ation de la paire">Cr√©√© le</th>
          <th title="Derni√®re mise √† jour DexScreener">MAJ DS</th>
        </tr>
      </thead>
      <tbody id="dexscreenerTbody"></tbody>
    </table>
  </div>

  <!-- Contenu Onglet Analyse -->
  <div id="analysis-content" class="tab-content">
    <div class="analysis-container">
      <h2>üìä Analyse des Donn√©es</h2>
      <div class="metrics-grid" id="analysisMetrics"></div>
      <canvas id="scoreDistributionChart" style="max-height: 300px;"></canvas>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <button id="prevBtn" onclick="prevPage()" aria-label="Page pr√©c√©dente">Pr√©c√©dent</button>
    <span id="pageInfo"></span>
    <button id="nextBtn" onclick="nextPage()" aria-label="Page suivante">Suivant</button>
  </div>

  <script>
    let data = [], filteredData = [], currentPage = 1, perPage = 10;
    let refreshInterval = 30000;
    let refreshTimer = null;
    let isAutoRefreshEnabled = true;
    let currentTab = 'base';
    let cachedData = null;

    // === GESTION DES ONGLETS ===
    function switchTab(tabName, button) {
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName + '-content').classList.add('active');
      button.classList.add('active');
      currentTab = tabName;
      renderPage();
    }

    // === FONCTIONS UTILITAIRES ===
    function parseDateTime(dateString) {
      if (!dateString) return null;
      if (dateString.includes('T') || dateString.includes('Z')) {
        return new Date(dateString);
      } else {
        return new Date(dateString.replace(' ', 'T'));
      }
    }

    function formatLocalDateTime(dateString) {
      if (!dateString) return 'Inconnue';
      const date = parseDateTime(dateString);
      if (!date || isNaN(date.getTime())) return 'Invalide';
      return date.toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function getTimeAgo(dateString) {
      if (!dateString) return { text: 'Inconnue', className: 'updated-old' };
      const now = new Date();
      const updateTime = parseDateTime(dateString);
      if (!updateTime || isNaN(updateTime.getTime())) {
        return { text: 'Invalide', className: 'updated-old' };
      }
      const diffMs = now - updateTime;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      let text, className;
      if (diffMinutes < 1) {
        text = '√Ä l\'instant';
        className = 'updated-recent';
      } else if (diffMinutes < 60) {
        text = `${diffMinutes}min`;
        className = diffMinutes < 30 ? 'updated-recent' : 'updated-medium';
      } else if (diffHours < 24) {
        text = `${diffHours}h`;
        className = diffHours < 6 ? 'updated-medium' : 'updated-old';
      } else {
        text = `${diffDays}j`;
        className = 'updated-old';
      }
      return { text, className };
    }

    function formatPriceChange(value) {
      if (!value || value === 0) return { text: '0.00%', className: 'price-neutral' };
      const percentage = parseFloat(value).toFixed(2);
      const className = value > 0 ? 'price-positive' : 'price-negative';
      const prefix = value > 0 ? '+' : '';
      return { text: `${prefix}${percentage}%`, className };
    }

    // === FONCTIONS AUTO-REFRESH ===
    function toggleAutoRefresh() {
      isAutoRefreshEnabled = !isAutoRefreshEnabled;
      const toggle = document.getElementById('autoRefreshToggle');
      const indicator = document.getElementById('refreshIndicator');
      if (isAutoRefreshEnabled) {
        toggle.classList.add('active');
        indicator.classList.remove('paused');
        indicator.classList.add('active');
        startAutoRefresh();
      } else {
        toggle.classList.remove('active');
        indicator.classList.remove('active');
        indicator.classList.add('paused');
        stopAutoRefresh();
      }
      updateRefreshStatus();
    }

    function updateRefreshInterval() {
      const select = document.getElementById('refreshInterval');
      refreshInterval = parseInt(select.value);
      if (isAutoRefreshEnabled) {
        stopAutoRefresh();
        startAutoRefresh();
      }
      updateRefreshStatus();
    }

    function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);
      if (isAutoRefreshEnabled) {
        refreshTimer = setInterval(() => {
          fetchData();
        }, refreshInterval);
      }
    }

    function stopAutoRefresh() {
      if (refreshTimer) {
        clearInterval(refreshTimer);
        refreshTimer = null;
      }
    }

    function updateRefreshStatus() {
      const statusElement = document.getElementById('refreshStatus');
      const intervalText = refreshInterval >= 60000 ? 
        `${refreshInterval/60000}min` : 
        `${refreshInterval/1000}s`;
      statusElement.textContent = isAutoRefreshEnabled ? 
        `Auto-refresh: ${intervalText}` : 
        `Paused (${intervalText})`;
    }

    function showRefreshIndicator(active) {
      const indicator = document.getElementById('refreshIndicator');
      if (!indicator) return;
      if (active && isAutoRefreshEnabled) {
        indicator.innerHTML = `
          <div class="spinner"></div>
          <span>Actualisation...</span>
        `;
      } else {
        const intervalText = refreshInterval >= 60000 ? 
          `${refreshInterval/60000}min` : 
          `${refreshInterval/1000}s`;
        const statusText = isAutoRefreshEnabled ? 
          `Auto-refresh: ${intervalText}` : 
          `Paused (${intervalText})`;
        indicator.innerHTML = `
          <span>${isAutoRefreshEnabled ? 'üîÑ' : '‚è∏Ô∏è'}</span>
          <span>${statusText}</span>
        `;
      }
    }

    // === FONCTIONS PROGRESSION BONDING CURVE ===
    function getBondingProgressDisplay(status, progress) {
      if (!status || !['active', 'created'].includes(status.toLowerCase())) {
        return '<div class="no-progress">N/A</div>';
      }
      const progressValue = parseFloat(progress) || 0;
      if (progressValue <= 0) {
        return '<div class="no-progress">0%</div>';
      }
      let progressClass = '';
      if (progressValue >= 90) {
        progressClass = 'completed';
      } else if (progressValue < 30) {
        progressClass = 'low';
      }
      return `
        <div class="progress-container ${progressClass}" title="Progression: ${progressValue}%">
          <div class="progress-bar" style="width: ${Math.min(progressValue, 100)}%"></div>
          <div class="progress-text">${progressValue}%</div>
        </div>
      `;
    }

    function getBondingCurveDisplay(status) {
      if (!status) return '<span class="bonding-status bonding-unknown">Unknown</span>';
      const statusLower = String(status).toLowerCase().trim();
      const statusMap = {
        'created': '<span class="bonding-status bonding-created">Created</span>',
        'active': '<span class="bonding-status bonding-active">Active</span>',
        'completed': '<span class="bonding-status bonding-completed">Completed</span>',
        'migrated': '<span class="bonding-status bonding-migrated">Migrated</span>',
        'terminated': '<span class="bonding-status bonding-terminated">Terminated</span>'
      };
      return statusMap[statusLower] || 
             `<span class="bonding-status bonding-unknown">${status}</span>`;
    }

    // === FONCTIONS DE DONN√âES ===
    async function fetchData(page = 1, pageSize = perPage) {
      if (cachedData && isAutoRefreshEnabled) {
        data = cachedData;
        filteredData = [...data];
        renderPage();
        return;
      }
      showRefreshIndicator(true);
      try {
        const response = await fetch(`/api/tokens-detail?page=${page}&pageSize=${pageSize}`);
        if (!response.ok) throw new Error('R√©ponse API invalide');
        const result = await response.json();
        data = result.data || result;
        cachedData = data;
        filteredData = [...data];
        currentPage = page;
        renderPage();
        if (currentTab === 'analysis') updateAnalysis();
      } catch (error) {
        console.error('Erreur lors du chargement des donn√©es:', error);
        document.getElementById('baseTbody').innerHTML = '<tr><td colspan="13">Erreur lors du chargement des donn√©es</td></tr>';
      } finally {
        showRefreshIndicator(false);
      }
    }

    function isWithinTimeFilter(dateString, filterValue, filterUnit) {
      if (!dateString || !filterValue || !filterUnit) return true;
      const now = new Date();
      const updateTime = parseDateTime(dateString);
      if (!updateTime || isNaN(updateTime.getTime())) return false;
      const diffMs = now - updateTime;
      let thresholdMs;
      switch (filterUnit) {
        case 'minutes':
          thresholdMs = filterValue * 60 * 1000;
          break;
        case 'hours':
          thresholdMs = filterValue * 60 * 60 * 1000;
          break;
        case 'days':
          thresholdMs = filterValue * 24 * 60 * 60 * 1000;
          break;
        default:
          return true;
      }
      return diffMs <= thresholdMs;
    }

    // === FONCTIONS DE FILTRAGE ===
    function setTimeFilter(value, unit, btn) {
      document.getElementById('filterTimeValue').value = value;
      document.getElementById('filterTimeUnit').value = unit;
      document.querySelectorAll('#base-content .preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilters();
    }

    function clearTimeFilter(btn) {
      document.getElementById('filterTimeValue').value = '';
      document.getElementById('filterTimeUnit').value = '';
      document.querySelectorAll('#base-content .preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilters();
    }

    function setDexTimeFilter(value, unit, btn) {
      window.dexTimeValue = value;
      window.dexTimeUnit = unit;
      document.querySelectorAll('#dexscreener-content .preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyDexFilters();
    }

    function clearDexTimeFilter(btn) {
      window.dexTimeValue = null;
      window.dexTimeUnit = null;
      document.querySelectorAll('#dexscreener-content .preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyDexFilters();
    }

    function updateFilterCount() {
      const filterCount = document.querySelector('.filter-count');
      if (filterCount) filterCount.remove();
      const activeFilters = document.querySelectorAll(
        '#base-content .filter-panel input:not(:empty), ' +
        '#base-content .filter-panel select:not(:empty), ' +
        '#dexscreener-content .filter-panel input:not(:empty), ' +
        '#dexscreener-content .filter-panel select:not(:empty), ' +
        '.preset-btn.active'
      ).length;
      const filterCountSpan = document.createElement('span');
      filterCountSpan.className = 'filter-count';
      filterCountSpan.textContent = `Filtres actifs: ${activeFilters}`;
      filterCountSpan.style.cssText = 'margin-left: 1rem; font-size: 0.9rem; color: var(--primary);';
      document.querySelector('.controls').appendChild(filterCountSpan);
    }

    function highlightActiveFilters() {
      const baseInputs = [
        'filterSymbol', 'filterBondingStatus', 'filterProgressMin', 'filterProgressMax',
        'filterPriceMin', 'filterPriceMax', 'filterScoreMin', 'filterScoreMax',
        'filterLiquidityMin', 'filterLiquidityMax', 'filterVolumeMin', 'filterVolumeMax',
        'filterHoldersMin', 'filterHoldersMax', 'filterAgeMin', 'filterAgeMax',
        'filterRiskMin', 'filterRiskMax', 'filterDiscoveredAt', 'filterTimeValue', 'filterTimeUnit'
      ];

      baseInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.value.trim() !== '') {
          el.classList.add('filter-active');
        } else {
          el.classList.remove('filter-active');
        }
      });

      const dexInputs = [
        'dexFilterSymbol', 'dexFilterStatus', 'dexFilterPriceMin', 'dexFilterPriceMax',
        'dexFilterMarketCapMin', 'dexFilterMarketCapMax', 'dexFilterVolume1hMin',
        'dexFilterVolume6hMin', 'dexFilterVolume24hMin', 'dexFilterTxns24hMin',
        'dexFilterBuys24hMin', 'dexFilterSells24hMax', 'dexFilterLiquidityQuoteMin', 'dexFilterHasData'
      ];

      dexInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.value.trim() !== '') {
          el.classList.add('filter-active');
        } else {
          el.classList.remove('filter-active');
        }
      });

      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList[btn.classList.contains('active') ? 'add' : 'remove']('filter-active');
      });
    }

    function applyFilters() {
      const filters = {
        symbol: document.getElementById('filterSymbol').value.toLowerCase().trim(),
        bondingStatus: document.getElementById('filterBondingStatus').value.toLowerCase().trim(),
        progressMin: document.getElementById('filterProgressMin').value ? parseFloat(document.getElementById('filterProgressMin').value) : null,
        progressMax: document.getElementById('filterProgressMax').value ? parseFloat(document.getElementById('filterProgressMax').value) : null,
        priceMin: document.getElementById('filterPriceMin').value ? parseFloat(document.getElementById('filterPriceMin').value) : null,
        priceMax: document.getElementById('filterPriceMax').value ? parseFloat(document.getElementById('filterPriceMax').value) : null,
        scoreMin: document.getElementById('filterScoreMin').value ? parseFloat(document.getElementById('filterScoreMin').value) : null,
        scoreMax: document.getElementById('filterScoreMax').value ? parseFloat(document.getElementById('filterScoreMax').value) : null,
        liquidityMin: document.getElementById('filterLiquidityMin').value ? parseFloat(document.getElementById('filterLiquidityMin').value) : null,
        liquidityMax: document.getElementById('filterLiquidityMax').value ? parseFloat(document.getElementById('filterLiquidityMax').value) : null,
        volumeMin: document.getElementById('filterVolumeMin').value ? parseFloat(document.getElementById('filterVolumeMin').value) : null,
        volumeMax: document.getElementById('filterVolumeMax').value ? parseFloat(document.getElementById('filterVolumeMax').value) : null,
        holdersMin: document.getElementById('filterHoldersMin').value ? parseInt(document.getElementById('filterHoldersMin').value) : null,
        holdersMax: document.getElementById('filterHoldersMax').value ? parseInt(document.getElementById('filterHoldersMax').value) : null,
        ageMin: document.getElementById('filterAgeMin').value ? parseFloat(document.getElementById('filterAgeMin').value) : null,
        ageMax: document.getElementById('filterAgeMax').value ? parseFloat(document.getElementById('filterAgeMax').value) : null,
        riskMin: document.getElementById('filterRiskMin').value ? parseInt(document.getElementById('filterRiskMin').value) : null,
        riskMax: document.getElementById('filterRiskMax').value ? parseInt(document.getElementById('filterRiskMax').value) : null,
        discoveredAt: document.getElementById('filterDiscoveredAt').value,
        timeValue: document.getElementById('filterTimeValue').value ? parseInt(document.getElementById('filterTimeValue').value) : null,
        timeUnit: document.getElementById('filterTimeUnit').value
      };

      filteredData = data.filter(row => {
        const riskValue = 100 - (row.rug_score || 50);
        const updatedAt = row.updated_at || row.first_discovered_at;
        const rowBondingStatus = (row.bonding_curve_status || '').toLowerCase();
        const progressValue = parseFloat(row.bonding_curve_progress) || 0;
        return (
          (!filters.symbol || row.symbol.toLowerCase().includes(filters.symbol)) &&
          (!filters.bondingStatus || rowBondingStatus === filters.bondingStatus) &&
          (filters.progressMin === null || progressValue >= filters.progressMin) &&
          (filters.progressMax === null || progressValue <= filters.progressMax) &&
          (filters.priceMin === null || row.price_usdc >= filters.priceMin) &&
          (filters.priceMax === null || row.price_usdc <= filters.priceMax) &&
          (filters.scoreMin === null || row.invest_score >= filters.scoreMin) &&
          (filters.scoreMax === null || row.invest_score <= filters.scoreMax) &&
          (filters.liquidityMin === null || row.liquidity_usd >= filters.liquidityMin) &&
          (filters.liquidityMax === null || row.liquidity_usd <= filters.liquidityMax) &&
          (filters.volumeMin === null || row.volume_24h >= filters.volumeMin) &&
          (filters.volumeMax === null || row.volume_24h <= filters.volumeMax) &&
          (filters.holdersMin === null || row.holders >= filters.holdersMin) &&
          (filters.holdersMax === null || row.holders <= filters.holdersMax) &&
          (filters.ageMin === null || row.age_hours >= filters.ageMin) &&
          (filters.ageMax === null || row.age_hours <= filters.ageMax) &&
          (filters.riskMin === null || riskValue >= filters.riskMin) &&
          (filters.riskMax === null || riskValue <= filters.riskMax) &&
          (!filters.discoveredAt || new Date(row.first_discovered_at).toISOString().startsWith(filters.discoveredAt)) &&
          isWithinTimeFilter(updatedAt, filters.timeValue, filters.timeUnit)
        );
      });

      currentPage = 1;
      renderPage();
      updateFilterCount();
      highlightActiveFilters();
    }

    function applyDexFilters() {
      const dexFilters = {
        symbol: document.getElementById('dexFilterSymbol').value.toLowerCase().trim(),
        status: document.getElementById('dexFilterStatus').value.toLowerCase().trim(),
        priceMin: document.getElementById('dexFilterPriceMin').value ? parseFloat(document.getElementById('dexFilterPriceMin').value) : null,
        priceMax: document.getElementById('dexFilterPriceMax').value ? parseFloat(document.getElementById('dexFilterPriceMax').value) : null,
        marketCapMin: document.getElementById('dexFilterMarketCapMin').value ? parseFloat(document.getElementById('dexFilterMarketCapMin').value) : null,
        marketCapMax: document.getElementById('dexFilterMarketCapMax').value ? parseFloat(document.getElementById('dexFilterMarketCapMax').value) : null,
        volume1hMin: document.getElementById('dexFilterVolume1hMin').value ? parseFloat(document.getElementById('dexFilterVolume1hMin').value) : null,
        volume6hMin: document.getElementById('dexFilterVolume6hMin').value ? parseFloat(document.getElementById('dexFilterVolume6hMin').value) : null,
        volume24hMin: document.getElementById('dexFilterVolume24hMin').value ? parseFloat(document.getElementById('dexFilterVolume24hMin').value) : null,
        txns24hMin: document.getElementById('dexFilterTxns24hMin').value ? parseFloat(document.getElementById('dexFilterTxns24hMin').value) : null,
        buys24hMin: document.getElementById('dexFilterBuys24hMin').value ? parseFloat(document.getElementById('dexFilterBuys24hMin').value) : null,
        sells24hMax: document.getElementById('dexFilterSells24hMax').value ? parseFloat(document.getElementById('dexFilterSells24hMax').value) : null,
        liquidityQuoteMin: document.getElementById('dexFilterLiquidityQuoteMin').value ? parseFloat(document.getElementById('dexFilterLiquidityQuoteMin').value) : null,
        hasData: document.getElementById('dexFilterHasData').value
      };

      filteredData = data.filter(row => {
        const hasDexData = (row.dexscreener_price_usd || 0) > 0;
        const lastDexUpdate = row.last_dexscreener_update || row.updated_at;
        return (
          (!dexFilters.symbol || row.symbol.toLowerCase().includes(dexFilters.symbol)) &&
          (!dexFilters.status || row.status.toLowerCase() === dexFilters.status) &&
          (dexFilters.priceMin === null || (row.dexscreener_price_usd || 0) >= dexFilters.priceMin) &&
          (dexFilters.priceMax === null || (row.dexscreener_price_usd || 0) <= dexFilters.priceMax) &&
          (dexFilters.marketCapMin === null || (row.dexscreener_market_cap || 0) >= dexFilters.marketCapMin) &&
          (dexFilters.marketCapMax === null || (row.dexscreener_market_cap || 0) <= dexFilters.marketCapMax) &&
          (dexFilters.volume1hMin === null || (row.dexscreener_volume_1h || 0) >= dexFilters.volume1hMin) &&
          (dexFilters.volume6hMin === null || (row.dexscreener_volume_6h || 0) >= dexFilters.volume6hMin) &&
          (dexFilters.volume24hMin === null || (row.dexscreener_volume_24h || 0) >= dexFilters.volume24hMin) &&
          (dexFilters.txns24hMin === null || (row.dexscreener_txns_24h || 0) >= dexFilters.txns24hMin) &&
          (dexFilters.buys24hMin === null || (row.dexscreener_buys_24h || 0) >= dexFilters.buys24hMin) &&
          (dexFilters.sells24hMax === null || (row.dexscreener_sells_24h || 0) <= dexFilters.sells24hMax) &&
          (dexFilters.liquidityQuoteMin === null || (row.dexscreener_liquidity_quote || 0) >= dexFilters.liquidityQuoteMin) &&
          (!dexFilters.hasData || (dexFilters.hasData === 'true' ? hasDexData : !hasDexData)) &&
          (!window.dexTimeValue || !window.dexTimeUnit || isWithinTimeFilter(lastDexUpdate, window.dexTimeValue, window.dexTimeUnit))
        );
      });

      currentPage = 1;
      renderPage();
      updateFilterCount();
      highlightActiveFilters();
    }

    // === FONCTIONS D'AFFICHAGE ===
    function renderPage() {
      const start = (currentPage - 1) * perPage;
      const rows = filteredData.slice(start, start + perPage);
      if (currentTab === 'base') {
        renderBaseTable(rows);
      } else if (currentTab === 'dexscreener') {
        renderDexScreenerTable(rows);
      } else if (currentTab === 'analysis') {
        updateAnalysis();
      }
      updatePagination();
    }

    function renderBaseTable(rows) {
      const tbody = document.getElementById('baseTbody');
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" class="no-data">Aucune donn√©e ne correspond aux filtres</td></tr>';
      } else {
        tbody.innerHTML = rows.map(r => {
          const updatedAt = r.updated_at || r.first_discovered_at;
          const timeAgo = getTimeAgo(updatedAt);
          const discoveredAt = formatLocalDateTime(r.first_discovered_at);
          const fullUpdateTime = formatLocalDateTime(updatedAt);
          const bondingCurveDisplay = getBondingCurveDisplay(r.bonding_curve_status);
          const progressDisplay = getBondingProgressDisplay(r.bonding_curve_status, r.bonding_curve_progress);
          return `
            <tr>
              <td><span class="fav" onclick="toggleFav('${r.address}')">‚≠ê</span></td>
              <td><a href="https://dexscreener.com/solana/${r.address}" target="_blank">${r.symbol}</a></td>
              <td class="price">${(+r.price_usdc || 0).toFixed(8)}</td>
              <td class="score">${(+r.invest_score || 0).toFixed(1)}</td>
              <td>${Math.round(r.liquidity_usd || 0).toLocaleString()}</td>
              <td>${Math.round(r.volume_24h || 0).toLocaleString()}</td>
              <td>${r.holders || 0}</td>
              <td>${(+r.age_hours || 0).toFixed(1)}</td>
              <td>${Math.round(100 - (r.rug_score || 50))}</td>
              <td>${bondingCurveDisplay}</td>
              <td>${progressDisplay}</td>
              <td class="${timeAgo.className}" title="${fullUpdateTime}">${timeAgo.text}</td>
              <td title="${discoveredAt}">${discoveredAt}</td>
            </tr>
          `;
        }).join('');
      }
    }

    function renderDexScreenerTable(rows) {
      const tbody = document.getElementById('dexscreenerTbody');
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="22" class="no-data">Aucune donn√©e ne correspond aux filtres</td></tr>';
      } else {
        tbody.innerHTML = rows.map(r => {
          const dexUrl = r.dexscreener_url || `https://dexscreener.com/solana/${r.address}`;
          const dexUrlDisplay = (r.dexscreener_price_usd || 0) > 0 ? 
            `<a href="${dexUrl}" target="_blank">üîó Voir</a>` : 
            'N/A';
          const pairCreatedAt = formatLocalDateTime(r.dexscreener_pair_created_at);
          const lastDexUpdate = formatLocalDateTime(r.last_dexscreener_update || r.updated_at);
          const priceChange1h = formatPriceChange(r.dexscreener_price_change_1h);
          const priceChange6h = formatPriceChange(r.dexscreener_price_change_6h);
          const priceChange24h = formatPriceChange(r.dexscreener_price_change_h24);
          return `
            <tr>
              <td><span class="fav" onclick="toggleFav('${r.address}')">‚≠ê</span></td>
              <td><strong>${r.symbol}</strong></td>
              <td>${getTokenStatusDisplay(r.status)}</td>
              <td class="price">${(r.dexscreener_price_usd || 0).toFixed(8)}</td>
              <td>${Math.round(r.dexscreener_market_cap || 0).toLocaleString()}</td>
              <td>${(r.dexscreener_liquidity_base || 0).toFixed(2)}</td>
              <td>${Math.round(r.dexscreener_liquidity_quote || 0).toLocaleString()}</td>
              <td>${Math.round(r.dexscreener_volume_1h || 0).toLocaleString()}</td>
              <td>${Math.round(r.dexscreener_volume_6h || 0).toLocaleString()}</td>
              <td>${Math.round(r.dexscreener_volume_24h || 0).toLocaleString()}</td>
              <td class="${priceChange1h.className}">${priceChange1h.text}</td>
              <td class="${priceChange6h.className}">${priceChange6h.text}</td>
              <td class="${priceChange24h.className}">${priceChange24h.text}</td>
              <td>${r.dexscreener_txns_1h || 0}</td>
              <td>${r.dexscreener_txns_6h || 0}</td>
              <td>${r.dexscreener_txns_24h || 0}</td>
              <td style="color: #00ff88">${r.dexscreener_buys_1h || 0}</td>
              <td style="color: #ff6b6b">${r.dexscreener_sells_1h || 0}</td>
              <td style="color: #00ff88">${r.dexscreener_buys_24h || 0}</td>
              <td style="color: #ff6b6b">${r.dexscreener_sells_24h || 0}</td>
              <td>${dexUrlDisplay}</td>
              <td>${pairCreatedAt}</td>
              <td>${lastDexUpdate}</td>
            </tr>
          `;
        }).join('');
      }
    }

    function getTokenStatusDisplay(status) {
      if (!status) return '<span class="token-status status-unknown">Unknown</span>';
      const statusLower = String(status).toLowerCase().trim();
      const statusMap = {
        'active': '<span class="token-status status-active">Active</span>',
        'inactive': '<span class="token-status status-inactive">Inactive</span>',
        'no_dex_data': '<span class="token-status status-no_dex_data">No Dex</span>',
        'archived': '<span class="token-status status-archived">Archived</span>',
        'blacklisted': '<span class="token-status status-blacklisted">Blacklisted</span>'
      };
      return statusMap[statusLower] || `<span class="token-status status-unknown">${status}</span>`;
    }

    function updateAnalysis() {
      const metricsContainer = document.getElementById('analysisMetrics');
      if (filteredData.length === 0) {
        metricsContainer.innerHTML = '<div class="metric-card"><div class="metric-title">Aucune donn√©e √† analyser</div></div>';
        return;
      }

      const totalTokens = filteredData.length;
      const avgScore = filteredData.reduce((sum, token) => sum + (token.invest_score || 0), 0) / totalTokens;
      const avgLiquidity = filteredData.reduce((sum, token) => sum + (token.liquidity_usd || 0), 0) / totalTokens;
      const avgVolume = filteredData.reduce((sum, token) => sum + (token.volume_24h || 0), 0) / totalTokens;
      const avgHolders = filteredData.reduce((sum, token) => sum + (token.holders || 0), 0) / totalTokens;
      const highScoreTokens = filteredData.filter(token => (token.invest_score || 0) >= 80).length;
      const activeTokens = filteredData.filter(token => token.bonding_curve_status === 'active').length;
      const migratedTokens = filteredData.filter(token => token.bonding_curve_status === 'migrated').length;
      const tokensWithDexData = filteredData.filter(token => (token.dexscreener_price_usd || 0) > 0).length;
      const totalDexVolume = filteredData.reduce((sum, token) => sum + (token.dexscreener_volume_24h || 0), 0);
      const avgDexPrice = tokensWithDexData > 0 ? 
        filteredData.filter(token => (token.dexscreener_price_usd || 0) > 0)
          .reduce((sum, token) => sum + (token.dexscreener_price_usd || 0), 0) / tokensWithDexData : 0;
      const avgDexMarketCap = tokensWithDexData > 0 ?
        filteredData.filter(token => (token.dexscreener_market_cap || 0) > 0)
          .reduce((sum, token) => sum + (token.dexscreener_market_cap || 0), 0) / 
          filteredData.filter(token => (token.dexscreener_market_cap || 0) > 0).length : 0;
      const totalDexTxns24h = filteredData.reduce((sum, token) => sum + (token.dexscreener_txns_24h || 0), 0);
      const totalDexBuys24h = filteredData.reduce((sum, token) => sum + (token.dexscreener_buys_24h || 0), 0);
      const totalDexSells24h = filteredData.reduce((sum, token) => sum + (token.dexscreener_sells_24h || 0), 0);

      metricsContainer.innerHTML = `
        <div class="metric-card">
          <div class="metric-title">üìä Tokens Analys√©s</div>
          <div class="metric-value">${totalTokens}</div>
          <div class="metric-subtitle">Dans la s√©lection actuelle</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">‚≠ê Score Moyen</div>
          <div class="metric-value">${avgScore.toFixed(1)}</div>
          <div class="metric-subtitle">Score d'investissement</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üèÜ Tokens Premium</div>
          <div class="metric-value">${highScoreTokens}</div>
          <div class="metric-subtitle">${((highScoreTokens/totalTokens)*100).toFixed(1)}% avec score ‚â•80</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üìà Avec Donn√©es DexScreener</div>
          <div class="metric-value">${tokensWithDexData}</div>
          <div class="metric-subtitle">${((tokensWithDexData/totalTokens)*100).toFixed(1)}% des tokens</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üíß Liquidit√© Moyenne</div>
          <div class="metric-value">${(avgLiquidity/1000).toFixed(1)}K</div>
          <div class="metric-subtitle">Liquidit√© USD moyenne</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üìä Volume DexScreener 24h</div>
          <div class="metric-value">${(totalDexVolume/1000000).toFixed(2)}M</div>
          <div class="metric-subtitle">Volume total DexScreener</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üí∞ Prix Moyen DexScreener</div>
          <div class="metric-value">${avgDexPrice.toFixed(6)}</div>
          <div class="metric-subtitle">Prix moyen USD</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üéØ Market Cap Moyen</div>
          <div class="metric-value">${(avgDexMarketCap/1000000).toFixed(2)}M</div>
          <div class="metric-subtitle">Market cap moyen DexScreener</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üîÑ Tokens Actifs</div>
          <div class="metric-value">${activeTokens}</div>
          <div class="metric-subtitle">${((activeTokens/totalTokens)*100).toFixed(1)}% en bonding curve</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üöÄ Tokens Migr√©s</div>
          <div class="metric-value">${migratedTokens}</div>
          <div class="metric-subtitle">${((migratedTokens/totalTokens)*100).toFixed(1)}% sur Raydium</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üìä Transactions 24h</div>
          <div class="metric-value">${Math.round(totalDexTxns24h/1000)}K</div>
          <div class="metric-subtitle">Total transactions DexScreener</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">üíö Ratio Buys/Sells 24h</div>
          <div class="metric-value">${totalDexSells24h > 0 ? (totalDexBuys24h/totalDexSells24h).toFixed(2) : '‚àû'}</div>
          <div class="metric-subtitle">${totalDexBuys24h} buys / ${totalDexSells24h} sells</div>
        </div>
      `;

      // Graphique de distribution des scores
      const scoreRanges = { '0-20': 0, '21-40': 0, '41-60': 0, '61-80': 0, '81-100': 0 };
      filteredData.forEach(token => {
        const score = token.invest_score || 0;
        if (score <= 20) scoreRanges['0-20']++;
        else if (score <= 40) scoreRanges['21-40']++;
        else if (score <= 60) scoreRanges['41-60']++;
        else if (score <= 80) scoreRanges['61-80']++;
        else scoreRanges['81-100']++;
      });

      const ctx = document.getElementById('scoreDistributionChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(scoreRanges),
          datasets: [{
            label: 'Distribution des Scores',
            data: Object.values(scoreRanges),
            backgroundColor: 'rgba(0, 212, 255, 0.5)',
            borderColor: '#00d4ff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function updatePagination() {
      document.getElementById("pageInfo").textContent = 
        `Page ${currentPage} / ${Math.ceil(filteredData.length / perPage)} (${filteredData.length} tokens)`;
      document.getElementById("prevBtn").disabled = currentPage === 1;
      document.getElementById("nextBtn").disabled = currentPage === Math.ceil(filteredData.length / perPage);
    }

    // === FONCTIONS DE PAGINATION ===
    function changePerPage() {
      perPage = +document.getElementById("perPage").value;
      currentPage = 1;
      renderPage();
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderPage();
      }
    }

    function nextPage() {
      if (currentPage < Math.ceil(filteredData.length / perPage)) {
        currentPage++;
        renderPage();
      }
    }

    // === FONCTIONS DE CONTR√îLE ===
    function reloadData() {
      cachedData = null; // Reset cache
      fetchData();
      document.querySelectorAll('.filter-panel input').forEach(input => input.value = '');
      document.getElementById('filterTimeUnit').value = '';
      document.getElementById('filterBondingStatus').value = '';
      document.getElementById('dexFilterHasData').value = '';
      document.getElementById('dexFilterStatus').value = '';
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      applyFilters();
    }

    function resetFilters() {
        document.querySelectorAll('.filter-panel input').forEach(input => input.value = '');
        document.getElementById('filterTimeUnit').value = '';
        document.getElementById('filterBondingStatus').value = '';
        document.getElementById('filterDiscoveredAt').value = '';
        document.getElementById('dexFilterHasData').value = '';
        document.getElementById('dexFilterStatus').value = '';
        document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
        window.dexTimeValue = null;
        window.dexTimeUnit = null;
        filteredData = [...data];
        currentPage = 1;
        applyFilters();
        applyDexFilters();
    }

    // === FONCTIONS FAVORIS ===
    function toggleFav(address) {
    // Placeholder pour la gestion des favoris (√† impl√©menter selon votre backend)
    console.log(`Toggle favorite for address: ${address}`);
    // Exemple : envoyer une requ√™te au backend pour sauvegarder les favoris
    // fetch(`/api/favorites/toggle/${address}`, { method: 'POST' });
    }

    // === FONCTIONS D'EXPORTATION CSV ===
    function exportToCSV() {
    const headers = currentTab === 'base' ? [
        'Symbol', 'Price ($)', 'Score', 'Liquidity ($)', 'Volume 24h ($)', 'Holders',
        'Age (h)', 'Risk', 'Bonding Curve', 'Progress', 'Derni√®re MAJ', 'D√©couvert'
    ] : [
        'Symbol', 'Status', 'Prix DS ($)', 'Market Cap ($)', 'Liq. Base', 'Liq. Quote ($)',
        'Vol 1h ($)', 'Vol 6h ($)', 'Vol 24h ($)', 'Œî Prix 1h (%)', 'Œî Prix 6h (%)',
        'Œî Prix 24h (%)', 'Txns 1h', 'Txns 6h', 'Txns 24h', 'Buys 1h', 'Sells 1h',
        'Buys 24h', 'Sells 24h', 'URL DexScreener', 'Cr√©√© le', 'MAJ DS'
    ];

    const rows = filteredData.map(row => {
        if (currentTab === 'base') {
        return [
            row.symbol,
            (+row.price_usdc || 0).toFixed(8),
            (+row.invest_score || 0).toFixed(1),
            Math.round(row.liquidity_usd || 0),
            Math.round(row.volume_24h || 0),
            row.holders || 0,
            (+row.age_hours || 0).toFixed(1),
            Math.round(100 - (row.rug_score || 50)),
            row.bonding_curve_status || 'Unknown',
            parseFloat(row.bonding_curve_progress) || 0,
            formatLocalDateTime(row.updated_at || row.first_discovered_at),
            formatLocalDateTime(row.first_discovered_at)
        ];
        } else {
        return [
            row.symbol,
            row.status || 'Unknown',
            (row.dexscreener_price_usd || 0).toFixed(8),
            Math.round(row.dexscreener_market_cap || 0),
            (row.dexscreener_liquidity_base || 0).toFixed(2),
            Math.round(row.dexscreener_liquidity_quote || 0),
            Math.round(row.dexscreener_volume_1h || 0),
            Math.round(row.dexscreener_volume_6h || 0),
            Math.round(row.dexscreener_volume_24h || 0),
            (row.dexscreener_price_change_1h || 0).toFixed(2),
            (row.dexscreener_price_change_6h || 0).toFixed(2),
            (row.dexscreener_price_change_h24 || 0).toFixed(2),
            row.dexscreener_txns_1h || 0,
            row.dexscreener_txns_6h || 0,
            row.dexscreener_txns_24h || 0,
            row.dexscreener_buys_1h || 0,
            row.dexscreener_sells_1h || 0,
            row.dexscreener_buys_24h || 0,
            row.dexscreener_sells_24h || 0,
            row.dexscreener_url || `https://dexscreener.com/solana/${row.address}`,
            formatLocalDateTime(row.dexscreener_pair_created_at),
            formatLocalDateTime(row.last_dexscreener_update || row.updated_at)
        ];
        }
    });

  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(val => `"${val}"`).join(','))
  ].join('\n');

  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `token_report_${currentTab}_${new Date().toISOString()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// === FONCTIONS DE THEME ===
function toggleTheme() {
  document.body.classList.toggle('light-theme');
  localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
}

// === DEBOUNCING POUR LES FILTRES ===
function debounce(func, wait) {
  let timeout;
  return function (...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

const applyFiltersDebounced = debounce(applyFilters, 300);
const applyDexFiltersDebounced = debounce(applyDexFilters, 300);

// === INITIALISATION ===
function init() {
  // Charger le th√®me sauvegard√©
  if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light-theme');
  }

  // Ajouter les √©couteurs d'√©v√©nements pour les filtres
  document.querySelectorAll('#base-content .filter-panel input, #base-content .filter-panel select').forEach(input => {
    input.addEventListener('input', applyFiltersDebounced);
  });

  document.querySelectorAll('#dexscreener-content .filter-panel input, #dexscreener-content .filter-panel select').forEach(input => {
    input.addEventListener('input', applyDexFiltersDebounced);
  });

  // Initialiser l'auto-refresh
  startAutoRefresh();
  updateRefreshStatus();

  // Charger les donn√©es initiales
  fetchData();
}

// Appeler l'initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>